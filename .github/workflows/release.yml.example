name: Release

# Triggered by cog bump — produces tags like v1.2.3 or v1.0.0-beta.1
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  BINARY: scarff

jobs:
  # ── Gate ──────────────────────────────────────────────────────────────────────
  # Full CI must pass on the tag commit before any binary is built.
  ci-gate:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  # ── Build matrix ──────────────────────────────────────────────────────────────
  build:
    name: Build · ${{ matrix.target }}
    needs: ci-gate
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - {
              target: x86_64-unknown-linux-gnu,
              runner: ubuntu-latest,
              use-cross: false,
              ext: "",
              archive: tar.gz,
            }
          - {
              target: x86_64-unknown-linux-musl,
              runner: ubuntu-latest,
              use-cross: true,
              ext: "",
              archive: tar.gz,
            }
          - {
              target: aarch64-unknown-linux-gnu,
              runner: ubuntu-latest,
              use-cross: true,
              ext: "",
              archive: tar.gz,
            }
          - {
              target: aarch64-unknown-linux-musl,
              runner: ubuntu-latest,
              use-cross: true,
              ext: "",
              archive: tar.gz,
            }
          # macOS
          - {
              target: aarch64-apple-darwin,
              runner: macos-14,
              use-cross: false,
              ext: "",
              archive: tar.gz,
            }
          - {
              target: x86_64-apple-darwin,
              runner: macos-13,
              use-cross: false,
              ext: "",
              archive: tar.gz,
            }
          # Windows
          - {
              target: x86_64-pc-windows-msvc,
              runner: windows-latest,
              use-cross: false,
              ext: ".exe",
              archive: zip,
            }
          - {
              target: aarch64-pc-windows-msvc,
              runner: windows-latest,
              use-cross: false,
              ext: ".exe",
              archive: zip,
            }

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Swatinem/rust-cache v2 (v2.8.2, Nov 2025)
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.target }}

      # taiki-e/install-action v2 for cross
      - uses: taiki-e/install-action@v2
        if: matrix.use-cross == true
        with:
          tool: cross

      - name: Build (cargo)
        if: matrix.use-cross == false
        run: cargo build --release --target ${{ matrix.target }} --bin ${{ env.BINARY }} --locked

      - name: Build (cross)
        if: matrix.use-cross == true
        run: cross build --release --target ${{ matrix.target }} --bin ${{ env.BINARY }} --locked

      - name: Strip (Linux)
        if: runner.os == 'Linux'
        run: |
          BIN="target/${{ matrix.target }}/release/${{ env.BINARY }}"
          case "${{ matrix.target }}" in
            aarch64-*) command -v aarch64-linux-gnu-strip && aarch64-linux-gnu-strip "$BIN" || true ;;
            x86_64-*)  strip "$BIN" || true ;;
          esac

      - name: Strip (macOS)
        if: runner.os == 'macOS'
        run: strip "target/${{ matrix.target }}/release/${{ env.BINARY }}" || true

      - name: Smoke test (native only)
        if: matrix.use-cross == false
        shell: bash
        run: "./target/${{ matrix.target }}/release/${{ env.BINARY }}${{ matrix.ext }}"

      # Package (tar.gz)
      - name: Package tar.gz
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          VER="${GITHUB_REF_NAME#v}"
          ARCHIVE="${{ env.BINARY }}-${VER}-${{ matrix.target }}.tar.gz"
          cp "target/${{ matrix.target }}/release/${{ env.BINARY }}" "${{ env.BINARY }}"
          tar czf "$ARCHIVE" "${{ env.BINARY }}" README.md CHANGELOG.md
          sha256sum "$ARCHIVE" > "$ARCHIVE.sha256"
          echo "ASSET=$ARCHIVE" >> "$GITHUB_ENV"
          echo "CHECKSUM=$ARCHIVE.sha256" >> "$GITHUB_ENV"

      # Package (zip)
      - name: Package zip
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          $VER = $env:GITHUB_REF_NAME -replace '^v', ''
          $ARCHIVE = "${{ env.BINARY }}-${VER}-${{ matrix.target }}.zip"
          $SRC = "target\${{ matrix.target }}\release\${{ env.BINARY }}${{ matrix.ext }}"
          Compress-Archive -Path $SRC, "README.md", "CHANGELOG.md" -DestinationPath $ARCHIVE
          $HASH = (Get-FileHash $ARCHIVE -Algorithm SHA256).Hash.ToLower()
          "$HASH  $ARCHIVE" | Out-File "$ARCHIVE.sha256" -Encoding ascii
          Add-Content $env:GITHUB_ENV "ASSET=$ARCHIVE"
          Add-Content $env:GITHUB_ENV "CHECKSUM=$ARCHIVE.sha256"

      # actions/upload-artifact v4 (v3 deprecated Jan 2025 and removed)
      - uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: |
            ${{ env.ASSET }}
            ${{ env.CHECKSUM }}
          retention-days: 1

  # ── GitHub Release ────────────────────────────────────────────────────────────
  publish-github:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # actions/download-artifact v4 (v3 deprecated Jan 2025 and removed)
      - uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: dist/

      - name: Extract changelog section
        id: notes
        shell: bash
        run: |
          VER="${GITHUB_REF_NAME#v}"
          NOTES=$(awk "/^## \[${VER}\]/{found=1;next} found && /^## \[/{exit} found{print}" CHANGELOG.md)
          [ -z "$NOTES" ] && NOTES="See [CHANGELOG.md](CHANGELOG.md) for details."
          { echo "body<<EOF"; echo "$NOTES"; echo "EOF"; } >> "$GITHUB_OUTPUT"

      # softprops/action-gh-release v2 (current)
      - uses: softprops/action-gh-release@v2
        with:
          name: "Scarff ${{ github.ref_name }}"
          body: ${{ steps.notes.outputs.body }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── crates.io ─────────────────────────────────────────────────────────────────
  # Publish order matches cog.toml bump_order: core(1) → adapters(2) → cli(3)
  publish-crates:
    name: Publish to crates.io
    needs: build
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref_name, '-') }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Publish scarff-core
        working-directory: crates/scarff-core
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index
        run: sleep 30

      - name: Publish scarff-adapters
        working-directory: crates/scarff-adapters
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index
        run: sleep 30

      - name: Publish scarff-cli
        working-directory: crates/scarff-cli
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
